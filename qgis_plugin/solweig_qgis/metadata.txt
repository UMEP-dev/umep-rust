[general]
name=SOLWEIG
qgisMinimumVersion=3.28
description=Calculate Mean Radiant Temperature & UTCI thermal comfort using the SOLWEIG model.
version=0.1.0-beta34
author=SOLWEIG Development Team
email=gareth.simons@ucl.ac.uk

about=SOLWEIG (Solar and Longwave Environmental Irradiance Geometry) is a high-performance urban microclimate model for calculating Mean Radiant Temperature and thermal comfort indices.

    Features:
    - Single timestep and timeseries Tmrt calculations
    - UTCI (Universal Thermal Climate Index) computation
    - PET (Physiological Equivalent Temperature) computation
    - Sky View Factor (SVF) preprocessing
    - EPW & SUEWS weather file import
    - Support for large rasters via tiled processing and GPU

    Requirements:
    - The SOLWEIG Python library must be installed separately.
    - The plugin will offer to install it automatically on first use.
    - To install manually, run this in the QGIS Python Console:
      import pip; pip.main(["install", "solweig"])

    This plugin provides QGIS Processing algorithms that wrap the SOLWEIG Python library. This version of Solweig is currently in testing as a proof of concept for Rust + GPU + tiled processing to handle large rasters.

    Adapted from UMEP (Urban Multi-scale Environmental Predictor) by Fredrik Lindberg, Sue Grimmond, and contributors. If you use this plugin in research, please cite:

    Lindberg F, Grimmond CSB, Gabey A, Huang B, Kent CW, Sun T, Theeuwes N, Järvi L, Ward H, Capel-Timms I, Chang YY, Jonsson P, Krave N, Liu D, Meyer D, Olofson F, Tan JG, Wästberg D, Xue L, Zhang Z (2018) Urban Multi-scale Environmental Predictor (UMEP) - An integrated tool for city-based climate services. Environmental Modelling and Software 99, 70-87 https://doi.org/10.1016/j.envsoft.2017.09.020

tracker=https://github.com/UMEP-dev/solweig/issues
repository=https://github.com/UMEP-dev/solweig
homepage=https://umep-docs.readthedocs.io/

hasProcessingProvider=yes
tags=urban climate, thermal comfort, mean radiant temperature, UTCI, PET, microclimate, heat stress, urban planning

category=Analysis
icon=icon.png

experimental=True
deprecated=False

changelog=
    0.1.0-beta34
    - Use local relief for max_height; harden NaN handling; fix SVF tile-size context
    0.1.0-beta33
    - GPU and processing performance improvements
    - Pixel-size-keyed SVF/wall cache paths for multi-resolution support
    - Async output writing and streaming timeseries mode
    0.1.0-beta32
    - Bump v0.1.0-beta32
    0.1.0-beta31
    - Bump v0.1.0-beta31
    0.1.0-beta30
    - Reuse precomputed SVF and shadow matrices in tiled timeseries by loading once and slicing per tile
    - Avoid per-timestep tile surface re-extraction in QGIS tiled timeseries (reuse pre-sliced tile inputs across all timesteps)
    - Prevent fallback SVF recomputation when precomputed.svf is available but surface.svf is missing
    0.1.0-beta29
    - Configurable tile orchestration: tile_workers, tile_queue_depth, prefetch_tiles params on calculate_tiled, calculate_timeseries_tiled, and calculate_timeseries (with ModelConfig integration)
    - Backpressure-controlled tile dispatch: bounded inflight limit prevents memory spikes from unbounded task submission
    - Memory-aware prefetch auto-selection: _resolve_prefetch_default enables prefetch only when estimated inflight bytes fit within 50 percent of usable RAM
    - Adaptive worker count: defaults to max(2, min(6, cpu_count // 2)), capped at tile count, with validation (tile_workers < 1 raises ValueError)
    - Telemetry instrumentation: mean tile turnaround time and max queue depth logged per dispatch cycle
    - Config serialization: tile_workers, tile_queue_depth, prefetch_tiles round-trip through ModelConfig save/load
    0.1.0-beta28
    - Optimize tiled timeseries: pre-create tile surfaces before timestep loop (eliminates N_timesteps × N_tiles redundant copies, preserves GVF cache + buffer pool across timesteps)
    - Parallel tile execution via ThreadPoolExecutor (Rust releases GIL during compute_timestep, allowing Python prep to overlap with Rust compute)
    - Add clarifying comments to GPU resource model explaining dual-constraint design (GPU staging vs RAM working memory)
    - Add tiled+anisotropic parity test verifying shadow matrix slicing produces matching results
    0.1.0-beta27
    - Fix 4 tiling bugs: remove forced pipelining split, fix tile-size semantics, enable anisotropic sky in tiled mode, fix overlap buffer elevation
    - Remove MIN_PIPELINING_SIDE (512px) threshold that forced 4-tile splitting on medium rasters — tiling now only triggers when resource limits require it
    - Fix tile-size semantics: validate_tile_size now correctly checks core + 2*overlap against resource limit (previously checked core only, so actual tiles could exceed GPU/RAM)
    - Enable anisotropic sky in tiled mode: shadow matrices are now spatially sliced per tile (previously silently dropped, falling back to isotropic)
    - Fix overlap buffer using absolute DSM elevation instead of relative building height (e.g. 10m ground + 5m building used 15m instead of 5m)
    - Free result arrays after writing to disk in timeseries mode (previously retained all timestep arrays in memory even with output_dir set)
    0.1.0-beta26
    - Apply vegetation transmissivity (psi) to isotropic diffuse SVF: drad, Kup, and Kdown now account for light passing through canopy (previously treated as fully opaque)
    - Add configurable leaf-off transmissivity to physics defaults (was hardcoded to 0.5)
    - Expose vegetation parameters in QGIS: transmissivity (leaf-on/off), seasonal leaf dates — all as advanced options
    0.1.0-beta25
    - Fix GVF shadow convention inversion: simplified (no-walls) path now correctly attenuates ground temperature in shaded areas instead of sunlit areas
    - Fix CDSM/TDSM below-threshold clamping: near-ground vegetation now clamps to base elevation instead of absolute zero
    - Fix state mutation in thermal delay: copy state before mutating to prevent cross-timestep contamination
    - Fix nighttime result NaN propagation: NaN pixels in DSM now propagate to nighttime Tmrt output
    - Fix division by zero in diffuse fraction at sunrise/sunset (sin(altitude) ≈ 0)
    - Fix log(0) crash in clearness index when sun is exactly at horizon
    - Fix TMY date filter for month-crossing ranges (e.g. Dec→Jan)
    - Fix altmax not floored at 0 for polar winter (negative max sun altitude)
    - Fix missing conifer/precomputed parameters in single-tile fallback path
    - Mark non-fused calculate_core() as deprecated in favour of Rust pipeline
    0.1.0-beta24
    - Skip tiling for nighttime timesteps: compute nighttime result on full grid in one pass instead of iterating all tiles
    - Nighttime timesteps now complete in milliseconds instead of processing N tiles with GPU pipeline overhead
    0.1.0-beta23
    - Fix EPW hour-24 timestamp bug: hour 24 now correctly maps to midnight of the next day instead of 00:00 of the same day
    - Fix hardcoded Gothenburg lat/lon defaults: EPW download and SOLWEIG calculation now default to the map canvas centre (WGS 84)
    0.1.0-beta22
    - GPU pipelining: auto-split rasters >= 512px into at least 4 tiles (2x2) for sustained GPU utilisation
    - Previously, height-aware buffer could cause medium rasters to fit in a single tile, leaving the GPU idle during CPU-only pipeline steps
    - Add opt-in timing instrumentation (SOLWEIG_TIMING=1) to measure per-step CPU/GPU breakdown and GPU duty cycle
    - Timing covers both Rust pipeline steps (shadow, ground temp, GVF, thermal delay, radiation, Tmrt) and Python tile overhead (extract, FFI, merge)
    0.1.0-beta21
    - Height-aware tile buffer: compute overlap from tallest DSM pixel via calculate_buffer_distance() instead of always using max_shadow_distance_m (500m default)
    - Short buildings (e.g. 10m) now get ~191m buffer instead of 500m, reducing tile count and overlap waste
    - Fix stale log line in calculate_tiled() that reported max_shadow_distance_m instead of actual buffer
    - Remove shadowed logger in calculate_tiled()
    0.1.0-beta20
    - QGIS progress monitor now shows current timestamp and tile during timeseries runs
    - Auto-tile large rasters in QGIS timeseries path (was previously untiled, risking OOM)
    - Resource-aware tile sizing: query real GPU buffer limits (wgpu adapter) and system RAM instead of hardcoded 256 MiB / 2500 px constants
    - Expose gpu_limits() from Rust to Python (solweig.get_gpu_limits())
    - Larger tile sizes on capable hardware (fewer tiles = less overhead)
    0.1.0-beta19
    - Fix import sorting and unused imports (ruff formatting)
    0.1.0-beta18
    - Enable anisotropic sky model by default (use_anisotropic_sky=True)
    - Port Perez sky luminance model to Rust (eliminates Python round-trip)
    - Fix bitpacked shadow matrix extraction in pipeline (was reading packed bytes as patch values)
    - Fix veg shadow initialization: no-vegetation surfaces no longer attenuate diffuse radiation
    - Release GIL during compute_timestep for better multi-threaded performance
    - Add steradians caching on ShadowArrays
    - Add 38 new tests: bitpacking round-trip, diffsh formula, Perez parity, end-to-end anisotropic pipeline
    0.1.0-beta17
    - Install solweig with --no-deps in QGIS to avoid replacing bundled numpy (fixes gdal_array ABI mismatch crash)
    0.1.0-beta16
    - Catch all exceptions (not just ImportError) when importing solweig, so the upgrade prompt still appears when an old version crashes on import (e.g. rasterio incompatibility)
    0.1.0-beta15
    - Force GDAL backend via UMEP_USE_GDAL env var before importing solweig (fixes rasterio detection in QGIS)
    0.1.0-beta14
    - Gate QGIS plugin build workflow on passing tests before release
    - Fix test_gdal_backend_env_variable reload failure in CI
    0.1.0-beta13
    - Add Location.from_epw() for automatic lat/lon/timezone extraction from EPW files
    - Enable anisotropic sky model in tiled mode (was previously blocked)
    - Fix SVF cache not reused across runs (pixel_size missing from cache metadata)
    - Fix SVF cache validation when loaded from zip format
    - Clean up stale SVF zip/npz files when cache is invalidated
    - Enforce release-mode Rust builds in CI and test suite (RELEASE_BUILD flag)
    - Fix test instability from QGIS mock module contamination
    0.1.0-beta12
    - CI: create GitHub Release with wheels on tag push
    0.1.0-beta11
    - Fix PyPI upload: include LICENSE file in sdist (maturin include directive)
    0.1.0-beta10
    - Auto-fill NaN in DSM/CDSM/TDSM with DEM ground reference (fill_nan)
    - Clamp near-ground noise (< 0.1 m tolerance) to avoid shadow/SVF artefacts
    - QGIS plugin uses SurfaceData library methods for masking/cropping (single source of truth)
    - Only honor negative nodata sentinel values at raster load time
    0.1.0-beta9
    - Fix numpy dtype crash in QGIS: rasterio is no longer imported in OSGeo4W environments
    - Consolidate geospatial backend detection into shared _compat module
    0.1.0-beta8
    - Fix plugin not appearing in Processing Toolbox when solweig library is missing
    - Defer install prompt so it no longer blocks provider registration
    0.1.0-beta7
    - Publish workflow gates on passing tests before building wheels
    0.1.0-beta6
    - Auto-detect outdated solweig library and prompt to upgrade
    - Plugin version synced automatically from pyproject.toml
    0.1.0-beta5
    - Fixed CI: simplified QGIS plugin build workflow (removed stale --universal flag)
    - CI: tags no longer trigger redundant test/docs workflows
    0.1.0-beta4
    - Solweig library installed via pip (auto-prompted on first use)
    - EPW download uses QgsNetworkAccessManager (proxy support)
    - Removed bundled binaries for QGIS Plugin Repository compliance
    0.1.0-beta1 - First public beta
    - Memory optimizations for QGIS timeseries (~3 GB savings)
    - Cancellable wall aspect and SVF computations
    - Input height validation warnings (DSM/CDSM sanity checks)
    - Surface preprocessing algorithm
    - Anisotropic sky model with Rust acceleration
    - GPU-accelerated shadow computation
    0.1.0-alpha1 - Internal alpha
    - Single timestep Tmrt calculation
    - Timeseries Tmrt calculation with thermal state
    - SVF preprocessing
    - UTCI and PET post-processing
    - EPW weather file import
    - Tiled processing for large rasters
